---
title: Redis主键过期机制
category:
  - 中间件
tag:
  - Redis
---

# Redis主键过期机制

## 前言

想象一下，你有一个仓库存放各种物品，每个物品都有一个保质期标签。Redis缓存系统就像这个仓库，而主键过期机制就是定期检查和清理过期物品的管理员。

Redis提供了多个命令来设置数据的过期时间，比如：
- `EXPIRE` - 设置秒级过期时间
- `PEXPIRE` - 设置毫秒级过期时间  
- `SETEX` - 设置值的同时指定过期时间

一旦数据设置了过期时间，到期后就会自动删除（准确说是变得无法访问）。

## 一、过期时间的管理规则

### 什么情况下会取消过期时间？

除了使用`PERSIST`命令主动取消过期时间，还有以下几种情况：

1. **删除主键时** - 用`DEL`命令删除主键时，过期时间自然消失
2. **主键被完全覆盖时** - 注意是主键被覆盖，不是值被修改

**举个例子：**
```redis
SET mykey "hello" EX 60   # 设置mykey，60秒后过期
SET mykey "world"         # 重新设置mykey，过期时间被取消
INCR counter              # 只是修改值，不会影响过期时间
```

**区别很重要：**
- 会取消过期时间的操作：`SET`、`MSET`、`GETSET`（这些会覆盖整个主键）
- 不会取消过期时间的操作：`INCR`、`DECR`、`LPUSH`、`HSET`（这些只修改值）

3. **RENAME命令的特殊情况**
   - 重命名一个主键时，过期时间会转移到新名字上
   - 如果重命名时覆盖了另一个主键，被覆盖主键的过期时间会消失

## 二、Redis如何删除过期的主键？

Redis使用两种策略来删除过期主键，就像仓库管理员的两种工作方式：

### 策略一：被动删除（懒惰删除）

**工作原理：** 当有人来取某个物品时，管理员才检查这个物品是否过期

**具体实现：**
- 每次访问数据时（GET、MGET等），Redis会先检查是否过期
- 如果过期了，立即删除并返回"不存在"
- 这个检查过程对用户是透明的

**代码实现逻辑：**
```
访问主键时：
1. 检查主键是否设置了过期时间
2. 如果没有过期时间，直接返回数据
3. 如果有过期时间，比较当前时间和过期时间
4. 如果已过期，删除主键并广播删除消息
5. 返回相应结果
```

**重要提醒：** 从服务器（Slave）不会主动删除过期主键，它们只听主服务器（Master）的指令！

### 策略二：主动删除（定期清理）

**工作原理：** 管理员定期巡视仓库，主动查找和清理过期物品

**为什么需要这种策略？**
如果某些过期数据很久没人访问，被动删除永远不会触发，这些"僵尸数据"会浪费内存。

**具体实现：**

1. **定时执行：** Redis每秒执行10次清理任务（可配置）

2. **随机抽样检查：**
   - 每次最多处理16个数据库
   - 从每个数据库中随机选择10个有过期时间的主键
   - 删除其中已过期的主键

3. **智能继续策略：**
   - 如果过期主键比例超过25%，说明过期数据很多
   - 继续在当前数据库进行下一轮抽样删除
   - 直到过期比例降到25%以下才处理下一个数据库

4. **性能保护机制：**
   - 限制每次清理的最长执行时间
   - 避免清理任务占用过多CPU资源
   - 确保Redis正常服务不受影响

**数据存储结构：**
Redis使用两个字典来管理数据：
- `dict` - 存储所有主键和值的映射
- `expires` - 专门存储有过期时间的主键和对应的过期时间

## 三、与Memcached的对比

| 对比项目 | Redis | Memcached |
|---------|-------|-----------|
| 被动删除 | ✓ 访问时检查并删除 | ✓ 访问时检查但不真正删除 |
| 主动删除 | ✓ 定期清理过期数据 | ✗ 不需要定期清理 |
| 内存管理 | 真正删除过期数据 | 只是标记为可用，空间可被新数据复用 |
| LRU机制 | 可配置使用 | 默认使用LRU回收长期未访问的数据 |

**简单理解：**
- Redis像真正的清洁工，会把垃圾扔掉
- Memcached像回收站，把空间标记为可重复使用

## 四、性能影响与最佳实践

### Redis的优化措施

1. **时间限制** - 每次清理任务有时间上限，不会无限执行
2. **数据库限制** - 每次最多处理16个数据库，分批进行
3. **抽样机制** - 不检查所有数据，只随机抽样检查
4. **比例控制** - 过期数据不多时就停止清理

### 需要注意的性能问题

**避免"雪崩"：** 如果大量主键在同一时间过期，会导致：
- 清理任务执行时间过长
- 系统响应速度变慢
- 用户体验下降

**最佳实践建议：**
1. **分散过期时间** - 给过期时间加上随机值，避免同时过期
2. **合理设置过期时间** - 不要设置过多不必要的过期主键
3. **监控系统性能** - 关注过期主键删除的统计信息

## 总结

Redis的主键过期机制就像一个智能的仓库管理系统：
- **被动模式** - 有人来取东西时才检查是否过期
- **主动模式** - 定期巡查清理过期物品
- **性能优先** - 通过多种限制机制确保清理工作不影响正常服务

这个设计既保证了内存的有效使用，又维护了系统的高性能运行。