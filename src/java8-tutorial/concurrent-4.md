---
title: CASåŸç†è¯¦è§£
category:
  - Java8
  - æ ¸å¿ƒç‰¹æ€§
tag:
  - CAS
---

# âœ… CASï¼ˆCompare-And-Swapï¼‰åŸç†è¯¦è§£

## ğŸ”¹ ä¸€ã€ä»€ä¹ˆæ˜¯ CASï¼Ÿ

CASï¼ˆCompare-And-Swapï¼‰æ˜¯ä¸€ç§ **åŸå­æ“ä½œ**ï¼Œç”¨äºå®ç°æ— é”å¹¶å‘ã€‚å®ƒé€šè¿‡**æ¯”è¾ƒå†…å­˜ä¸­å½“å‰å€¼æ˜¯å¦ä¸ºæœŸæœ›å€¼**ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å…è®¸æ›´æ–°ï¼š

> **åŸå­è¯­ä¹‰**ï¼šå¦‚æœå½“å‰å€¼ == æœŸæœ›å€¼ï¼Œå°±å°†å…¶æ›´æ–°ä¸ºæ–°å€¼ï¼›å¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚

---

## ğŸ”¹ äºŒã€CAS æ“ä½œçš„ä¸‰ä¸ªå‚æ•°

CAS æ“ä½œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š

| å‚æ•° | å«ä¹‰              |
| -- | --------------- |
| V  | å˜é‡å½“å‰å€¼ï¼ˆæ¥è‡ªå†…å­˜ï¼‰     |
| A  | æœŸæœ›çš„æ—§å€¼ï¼ˆExpectedï¼‰ |
| B  | è¦æ›´æ–°çš„æ–°å€¼ï¼ˆNewï¼‰     |

ğŸ” å¦‚æœ V == Aï¼Œåˆ™æ‰§è¡Œ V = Bï¼›å¦åˆ™ CAS å¤±è´¥ï¼Œç­‰å¾…æˆ–é‡è¯•ã€‚

---

## ğŸ”¹ ä¸‰ã€CAS çš„åŸå­æ€§ä¿éšœ

CAS çš„åŸå­æ€§ç”± **CPU æä¾›çš„åº•å±‚æŒ‡ä»¤ä¿è¯**ï¼Œå¦‚ï¼š

* x86ï¼š`CMPXCHG`
* ARMï¼š`LDREX/STREX`
* Java ä¸­é€šè¿‡ `Unsafe` ç±»ã€`VarHandle`ã€`AtomicXXX` ç±»è°ƒç”¨ CPU åŸè¯­å®ç°åŸå­æ›´æ–°ã€‚

å› æ­¤ï¼Œ**å³ä¾¿å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ CASï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸæ›´æ–°ï¼Œå…¶ä»–çº¿ç¨‹ä¼šå¤±è´¥å¹¶è‡ªæ—‹é‡è¯•ã€‚**

---

## ğŸ”¹ å››ã€CAS ä¼˜ç‚¹

| ä¼˜ç‚¹      | è¯´æ˜                        |
| ------- | ------------------------- |
| âœ… æ— éœ€åŠ é”  | å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œæé«˜å¹¶å‘æ€§èƒ½          |
| âœ… åŸå­æ€§ä¿éšœ | ä¾èµ– CPU æŒ‡ä»¤åŸè¯­ï¼Œæ›´æ–°æ“ä½œä¸å¯ä¸­æ–­      |
| âœ… é«˜æ€§èƒ½   | ç‰¹åˆ«é€‚åˆäºä½å†²çªçš„å¹¶å‘åœºæ™¯ï¼Œä¾‹å¦‚è®¡æ•°å™¨ã€æ ‡å¿—æ›´æ–°ç­‰ |

---

## ğŸ”¹ äº”ã€CAS çš„å±€é™æ€§

### â‘  â— ABA é—®é¢˜

> å˜é‡ä» A â†’ B â†’ Aï¼ŒCAS æ£€æŸ¥ä»ä¸º Aï¼Œå¯¼è‡´ä»¥ä¸ºâ€œæœªæ”¹åŠ¨â€ï¼Œå®é™…å‘ç”Ÿäº†å˜åŒ–ã€‚

ğŸ›  è§£å†³æ–¹æ¡ˆï¼š

* ä½¿ç”¨å¸¦ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ï¼Œä¾‹å¦‚ Java ä¸­çš„ `AtomicStampedReference`
* æˆ–ä½¿ç”¨ `VarHandle.compareAndExchange(...)` ç­‰é«˜çº§åŸå­æ“ä½œ

---

### â‘¡ â— è‡ªæ—‹å¤±è´¥å¼€é”€å¤§

> å¤šçº¿ç¨‹é«˜å¹¶å‘æ—¶ï¼ŒCAS å¤±è´¥ä¼šä¸æ–­è‡ªæ—‹é‡è¯•ï¼Œå ç”¨ CPUã€‚

ğŸ›  è§£å†³æ–¹æ¡ˆï¼š

* è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–é€€é¿ç­–ç•¥ï¼ˆBackoffï¼‰
* ä½¿ç”¨æ›´é«˜çº§å¹¶å‘æ§åˆ¶ï¼Œå¦‚é”æˆ–é˜Ÿåˆ—

---

### â‘¢ â— åªèƒ½æ“ä½œä¸€ä¸ªå˜é‡

> CAS æ“ä½œé€šå¸¸åªèƒ½ä¿è¯ **å•å˜é‡çš„åŸå­æ€§**ï¼Œå¤šä¸ªå˜é‡éœ€ä½¿ç”¨ `AtomicReference` å°è£…å¯¹è±¡ï¼Œæˆ–ä½¿ç”¨é”æœºåˆ¶ã€‚

---

## ğŸ”¹ å…­ã€CAS å®ç°ç¤ºæ„ï¼ˆä¼ªä»£ç ï¼‰

```java
boolean compareAndSwap(V, A, B) {
    if (V == A) {
        V = B;
        return true;
    }
    return false;
}
```

åœ¨ Java ä¸­ï¼š

```java
AtomicInteger counter = new AtomicInteger(0);

// è‡ªæ—‹æ›´æ–°
int oldValue, newValue;
do {
    oldValue = counter.get();
    newValue = oldValue + 1;
} while (!counter.compareAndSet(oldValue, newValue));
```

---

## âœ… ä¸ƒã€æ€»ç»“

| ç‰¹æ€§     | å†…å®¹                                                           |
| ------ | ------------------------------------------------------------ |
| æ ¸å¿ƒåŸç†   | æ¯”è¾ƒå½“å‰å€¼æ˜¯å¦ä¸ºæœŸæœ›å€¼ï¼Œç›¸ç­‰åˆ™æ›´æ–°ä¸ºæ–°å€¼                                         |
| åŸå­æ€§ä¿éšœ  | ä¾èµ– CPU åŸå­æŒ‡ä»¤ï¼Œå¦‚ CMPXCHG                                        |
| å…¸å‹åº”ç”¨   | Java ä¸­çš„ `AtomicInteger`ã€`ConcurrentHashMap`ã€`LongAdder` ç­‰    |
| æ³¨æ„äº‹é¡¹   | é¿å… ABAã€è‡ªæ—‹è¿‡ä¹…ã€ä¸èƒ½æ›´æ–°å¤šä¸ªå˜é‡                                         |
| è§£å†³æ–¹æ¡ˆå»ºè®® | ä½¿ç”¨ `AtomicStampedReference`ã€`AtomicMarkableReference` ç­‰æ‰©å±•ç±»æ”¯æŒ |

---

